<?php

/**
 * è·å–äººå‘˜ä¿¡æ¯ç¤ºä¾‹
 * 
 * ä½¿ç”¨è¯´æ˜ï¼š
 * 1. é€šè¿‡ composer å®‰è£…: composer require sxqibo/fast-yks
 * 2. é…ç½®ä½ çš„ SP å·å’Œ SIDï¼ˆå­¦æ ¡ç¼–å·ï¼‰
 * 3. è¿è¡Œæ­¤ç¤ºä¾‹
 * 
 * æ³¨æ„ï¼šè®¿é—®æ§åˆ¶ä¸º 10æ¬¡/åˆ†ï¼Œè¯·æ§åˆ¶è°ƒç”¨é¢‘ç‡
 * 
 * ç‰¹åˆ«è¯´æ˜ï¼š
 * 1. å»ºè®®ä½¿ç”¨å¢é‡æ¨¡å¼ï¼Œæ¯æ¬¡è·å–200-400æ¡æ•°æ®ï¼Œè®°å½•æœ€åæ›´æ–°æ—¶é—´
 * 2. å»ºè®®å®šæ—¶å™¨(30åˆ†é’Ÿæœ€ä½³)è°ƒç”¨æœ¬æ¥å£ï¼Œå¢é‡æ¨¡å¼è·å–äººå‘˜æ”¹å˜çŠ¶æ€ä¿¡æ¯
 * 3. å¯¹æ¥æ–¹å¦‚æœéœ€è¦å¼€å‘ç±»ä¼¼å¯¼å‡ºåŠŸèƒ½ï¼Œå»ºè®®å¯ä»¥å†æ¬¡è°ƒç”¨æœ¬æ¥å£è·å–æœ€æ–°äººå‘˜ä¿¡æ¯å’Œä½™é¢ç­‰
 */

// è‡ªåŠ¨åŠ è½½ï¼šä¼˜å…ˆä½¿ç”¨ composerï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ç®€å•çš„ bootstrap
if (file_exists(__DIR__ . '/../vendor/autoload.php')) {
    require_once __DIR__ . '/../vendor/autoload.php';
} else {
    require_once __DIR__ . '/bootstrap.php';
}

use Sxqibo\FastYks\Config;
use Sxqibo\FastYks\Person;

// æ–¹å¼1ï¼šä»é…ç½®æ–‡ä»¶åŠ è½½ï¼ˆæ¨èï¼‰
Config::loadFromFile(__DIR__ . '/config.php');

// æ–¹å¼2ï¼šç›´æ¥è®¾ç½®é…ç½®
// Config::set(['sp' => 'your_sp_number', 'sid' => 14]);

try {
    // åˆ›å»º Person å®¢æˆ·ç«¯
    // æ–¹å¼Aï¼šä½¿ç”¨é…ç½®ä¸­çš„é»˜è®¤å€¼ï¼ˆæ¨èï¼‰
    $client = new Person();
    
    // æ–¹å¼Bï¼šæ‰‹åŠ¨ä¼ å…¥ SP å·å’Œ SID
    // $client = new Person('your_sp_number_here', 14);

    // ===== ç¤ºä¾‹1ï¼šè·å–å­¦ç”Ÿä¿¡æ¯ï¼ˆå…¨éƒ¨æ•°æ®ï¼‰ =====
    echo "=== ç¤ºä¾‹1ï¼šè·å–å­¦ç”Ÿä¿¡æ¯ï¼ˆå…¨éƒ¨æ•°æ®ï¼‰ ===\n";
    echo "æ­£åœ¨è·å–å­¦ç”Ÿä¿¡æ¯ï¼ˆç±»å‹ï¼š7ï¼Œç¬¬1é¡µï¼Œæ¯é¡µ200æ¡ï¼‰...\n";
    $students = $client->getUsers(1, 200, 7, '');
    
    if (empty($students)) {
        echo "è¯¥å­¦æ ¡ä¸‹æ²¡æœ‰å­¦ç”Ÿä¿¡æ¯\n";
    } else {
        echo "è·å–æˆåŠŸï¼æ‰¾åˆ° " . count($students) . " ä¸ªå­¦ç”Ÿï¼š\n";
        foreach ($students as $index => $student) {
            if ($index >= 5) { // åªæ˜¾ç¤ºå‰5æ¡
                echo "  ... è¿˜æœ‰ " . (count($students) - 5) . " æ¡æ•°æ®\n";
                break;
            }
            $name = $student['cust_name'] ?? 'æ— ';
            $id = $student['id'] ?? 'æ— ';
            $uid = $student['uid'] ?? 'æ— ';
            $idcard = $student['idcard'] ?? 'æ— ';
            $phone = $student['mobilephone'] ?? 'æ— ';
            $cashMoney = $student['cashMoney'] ?? '0.00';
            echo "  - {$name} (ID: {$id}, UID: {$uid}, ä½™é¢: {$cashMoney})\n";
            echo "    è¯ä»¶å·: {$idcard}, æ‰‹æœºå·: {$phone}\n";
        }
    }

    // ===== ç¤ºä¾‹2ï¼šè·å–æ•™å¸ˆä¿¡æ¯ =====
    echo "\n=== ç¤ºä¾‹2ï¼šè·å–æ•™å¸ˆä¿¡æ¯ï¼ˆç±»å‹ï¼š5ï¼‰ ===\n";
    echo "æ­£åœ¨è·å–æ•™å¸ˆä¿¡æ¯...\n";
    $teachers = $client->getUsers(1, 100, 5, '');
    
    if (empty($teachers)) {
        echo "è¯¥å­¦æ ¡ä¸‹æ²¡æœ‰æ•™å¸ˆä¿¡æ¯\n";
    } else {
        echo "è·å–æˆåŠŸï¼æ‰¾åˆ° " . count($teachers) . " ä¸ªæ•™å¸ˆï¼š\n";
        foreach ($teachers as $index => $teacher) {
            if ($index >= 3) { // åªæ˜¾ç¤ºå‰3æ¡
                echo "  ... è¿˜æœ‰ " . (count($teachers) - 3) . " æ¡æ•°æ®\n";
                break;
            }
            $name = $teacher['cust_name'] ?? 'æ— ';
            $id = $teacher['id'] ?? 'æ— ';
            echo "  - {$name} (ID: {$id})\n";
        }
    }

    // ===== ç¤ºä¾‹3ï¼šå¢é‡æ›´æ–°æ¨¡å¼ï¼ˆæ¨èï¼‰ =====
    echo "\n=== ç¤ºä¾‹3ï¼šå¢é‡æ›´æ–°æ¨¡å¼ç¤ºä¾‹ ===\n";
    echo "ï¼ˆæ³¨é‡Šä»£ç ï¼Œéœ€è¦æ—¶å¯ä»¥å–æ¶ˆæ³¨é‡Šä½¿ç”¨ï¼‰\n";
    
    /*
    // åˆå§‹å‚æ•°
    $lastUpdateTime = '2023-01-01 00:00:00'; // åˆå§‹æ—¶é—´ï¼Œæˆ–è€…ä»æ•°æ®åº“è¯»å–ä¸Šæ¬¡åŒæ­¥çš„æ—¶é—´
    $limit = 200; // æ¯æ¬¡è·å–200æ¡æ•°æ®ï¼ˆå»ºè®®200-400æ¡ï¼‰
    $type = 7; // äººå‘˜ç±»å‹ï¼š7å­¦ç”Ÿï¼Œ5æ•™å¸ˆï¼Œ6å®¶é•¿
    
    // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œåº”è¯¥ä½¿ç”¨å®šæ—¶å™¨ï¼ˆå¦‚æ¯30åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼‰
    // è¿™é‡Œä»…ä½œä¸ºç¤ºä¾‹å±•ç¤ºé€»è¾‘
    while (true) {
        try {
            echo "æ­£åœ¨è·å–æ›´æ–°æ—¶é—´ >= {$lastUpdateTime} çš„äººå‘˜ä¿¡æ¯...\n";
            $persons = $client->getUsers(1, $limit, $type, $lastUpdateTime);
            
            $count = count($persons);
            echo "è·å–åˆ° {$count} æ¡æ•°æ®\n";
            
            if ($count > 0) {
                // å¤„ç†æ•°æ®ä¸šåŠ¡é€»è¾‘
                // è¿™é‡Œå¯ä»¥å°†æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“æˆ–è¿›è¡Œå…¶ä»–å¤„ç†
                foreach ($persons as $person) {
                    // å¤„ç†æ¯æ¡äººå‘˜æ•°æ®
                    // ä¾‹å¦‚ï¼šä¿å­˜åˆ°æ•°æ®åº“ã€æ›´æ–°ç¼“å­˜ç­‰
                    echo "å¤„ç†äººå‘˜: " . ($person['cust_name'] ?? '') . "\n";
                }
                
                // è·å–æœ€åä¸€æ¡æ•°æ®çš„æ›´æ–°æ—¶é—´
                $lastPerson = $persons[$count - 1];
                $lastUpdateTimeField = $lastPerson['last_update_time'] ?? '';
                
                if (!empty($lastUpdateTimeField)) {
                    // last_update_time æ ¼å¼å¯èƒ½æ˜¯ ISO 8601 æ ¼å¼ï¼ˆå¦‚ï¼š2023-01-01T12:00:00.000+0000ï¼‰
                    // éœ€è¦è½¬æ¢ä¸º yyyy-MM-dd HH:mm:ss æ ¼å¼
                    try {
                        // å°è¯•è§£æ ISO 8601 æ ¼å¼
                        $dateTime = new \DateTime($lastUpdateTimeField);
                        // å¦‚æœéœ€è¦ï¼Œå¯ä»¥è®¾ç½®æ—¶åŒºä¸ºåŒ—äº¬æ—¶é—´
                        // $dateTime->setTimezone(new \DateTimeZone('Asia/Shanghai'));
                        $lastUpdateTime = $dateTime->format('Y-m-d H:i:s');
                        echo "æ›´æ–°æœ€ååŒæ­¥æ—¶é—´: {$lastUpdateTime}\n";
                    } catch (\Exception $e) {
                        // å¦‚æœè§£æå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹å€¼
                        $lastUpdateTime = $lastUpdateTimeField;
                        echo "ä½¿ç”¨åŸå§‹æ›´æ–°æ—¶é—´: {$lastUpdateTime}\n";
                    }
                }
            }
            
            // åˆ¤æ–­æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®
            if ($count < $limit) {
                // æ•°æ®è·å–å®Œæ¯•ï¼Œç­‰å¾…è¾ƒé•¿æ—¶é—´åå†æ¬¡åŒæ­¥
                echo "æš‚æ— æ–°æ•°æ®ï¼Œä¸‹æ¬¡åŒæ­¥æ—¶é—´: {$lastUpdateTime}\n";
                echo "ç­‰å¾…10åˆ†é’Ÿåå†æ¬¡åŒæ­¥...\n";
                sleep(10 * 60); // ç­‰å¾…10åˆ†é’Ÿ
            } else {
                // å¯èƒ½è¿˜æœ‰æ›´å¤šæ•°æ®ï¼Œç»§ç»­è·å–
                echo "ç»§ç»­è·å–ä¸‹ä¸€æ‰¹æ•°æ®...\n";
                sleep(3); // ç­‰å¾…3ç§’ï¼Œé¿å…è¶…è¿‡é¢‘ç‡é™åˆ¶ï¼ˆ10æ¬¡/åˆ†ï¼‰
            }
            
        } catch (\Exception $e) {
            echo "é”™è¯¯: " . $e->getMessage() . "\n";
            sleep(60); // å‡ºé”™åç­‰å¾…1åˆ†é’Ÿå†é‡è¯•
        }
    }
    */

    // ç»“æœç¤ºä¾‹ï¼š
    // [
    //   {
    //     "uid": "2088812471510971",
    //     "cust_type": 5,
    //     "sex": 1,
    //     "idcard": "513701198912070057",
    //     "cust_name": "ä½•å¸…",
    //     "id": 18,
    //     "mobilephone": "æ‰‹æœºå·",
    //     "cashMoney": "å½“å‰é‡‘é¢",
    //     "dayMaxMoney": "æ—¥é™é¢",
    //     "icCode": "ç‰©ç†å¡å·",
    //     "orgIds": "éƒ¨é—¨åˆ—è¡¨",
    //     "last_update_time": "æœ€åæ›´æ–°æ—¶é—´",
    //     "sign_state": "ç­¾çº¦çŠ¶æ€",
    //     "isZfbFace": "æ”¯ä»˜å®ç®—æ³•æ˜¯å¦é‡‡é›†äººè„¸"
    //   }
    // ]

} catch (\Exception $e) {
    echo "\nâŒ é”™è¯¯: " . $e->getMessage() . "\n";
    
    // å¦‚æœæ˜¯ 403 é”™è¯¯ï¼Œç»™å‡ºæ›´è¯¦ç»†çš„æç¤º
    if (strpos($e->getMessage(), '403') !== false || strpos($e->getMessage(), 'æ²¡æœ‰æ‰¾åˆ°spä¿¡æ¯') !== false) {
        echo "\nğŸ’¡ æç¤º: 403 é”™è¯¯é€šå¸¸æ˜¯å› ä¸º SP å·æ— æ•ˆæˆ–æœªé…ç½®ã€‚\n";
        echo "è§£å†³æ–¹æ³•ï¼š\n";
        echo "1. ç¡®ä¿ä½ ä½¿ç”¨çš„æ˜¯æœ‰æ•ˆçš„ SP å·ï¼ˆè¯·è”ç³»æ˜“ç§‘å£«å¯¹æ¥äººè·å–ï¼‰\n";
        echo "2. æ£€æŸ¥ sample/config.php ä¸­çš„ 'sp' é…ç½®æ˜¯å¦æ­£ç¡®\n";
        echo "3. æˆ–è€…ç›´æ¥åœ¨ä»£ç ä¸­ä¼ å…¥æœ‰æ•ˆçš„ SP å·\n";
    }
    
    // å¦‚æœæ˜¯å‚æ•°é”™è¯¯
    if (strpos($e->getMessage(), 'å‚æ•°é”™è¯¯') !== false) {
        echo "\nğŸ’¡ æç¤º:\n";
        echo "- é¡µæ•°å¿…é¡»å¤§äºç­‰äº1ä¸”ä¸èƒ½å¤§äº100\n";
        echo "- åˆ†é¡µæ¡æ•°å¿…é¡»å¤§äºç­‰äº1ä¸”ä¸èƒ½å¤§äº1000\n";
        echo "- äººå‘˜ç±»å‹åªèƒ½æ˜¯ 5ï¼ˆæ•™å¸ˆæˆ–ä¼ä¸šå‘˜å·¥ï¼‰ã€6ï¼ˆå®¶é•¿ï¼‰æˆ– 7ï¼ˆå­¦ç”Ÿï¼‰\n";
    }
    
    // å¦‚æœæ˜¯ SID é”™è¯¯
    if (strpos($e->getMessage(), 'SID') !== false) {
        echo "\nğŸ’¡ æç¤º: è¯·ç¡®ä¿é…ç½®äº†æ­£ç¡®çš„ SIDï¼ˆå­¦æ ¡ç¼–å·ï¼‰ã€‚\n";
        echo "å¯ä»¥é€šè¿‡ Config::set(['sid' => å­¦æ ¡ç¼–å·]) æˆ–æ„é€ å‡½æ•°ä¼ å…¥ã€‚\n";
    }
}

